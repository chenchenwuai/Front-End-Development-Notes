### 导言
本文主要介绍提供HTTP/3以及其底层协议QUIC的文档，介绍它们的目的、原理、协议细节以及实现等。摘抄自[HTTP3详解](https://http3-explained.haxx.se/zh/zh)


### 为什么需要QUIC
QUIC可以被视为一种新型的可靠且安全的传输层协议，QUIC的用途不局限于HTTP的传输
- 独立的数据流避免类似TCP队头阻塞问题
- 安全。想要建立一个QUIC连接，就必须通过TLS 1.3来安全地建立一个加密连接
- QUIC提供了0-RTT和1-RTT的握手，这减少了协商和建立新连接时所需的时间
#### HTTP2简介
- 多路复用
    + 通过同一个TCP连接发送多个逻辑数据流，复用带来更好的拥塞控制、更充分的带宽利用、更长久的TCP连接
- 头信息压缩
- 新的二进制分帧层协议
- 服务器推送

采用HTTP/2后，浏览器对每个主机一般只需要一个TCP连接，而不是以前常见的六个连接。

HTTP/2解决了HTTP的`队头拥塞`（head of line blocking）问题（客户端必须等待一个请求完成才能发送下一个请求）。


#### TCP队头阻塞（head of line blocking）
采用HTTP/2时，浏览器一般会在单个TCP连接中创建并行的几十个乃至上百个传输。如果HTTP/2连接双方的网络中有一个数据包丢失，或者任何一方的网络出现中断，
整个TCP连接就会暂停，丢失的数据包需要被重新传输。因为TCP是一个按序传输的链条，从TCP连接一端填入的字节会从另一端以原有的顺序，正确地传送出来，因此
如果其中一个点丢失了，链路上之后的内容就都需要等待。

这种单个数据包造成的阻塞，就是TCP上的队头阻塞（head of line blocking）。
随着丢包率的增加，HTTP/2的表现越来越差。在2%的丢包率（一个很差的网络质量）中，测试结果表明HTTP/1用户的性能更好，因为HTTP/1一般有六个TCP连接，哪怕其中一个连接阻塞了，其他没有丢包的连接仍然可以继续传输。
在限定的条件下，在TCP下解决这个问题相当困难。

#### 为什么不发明一个UDP和TCP之外的新型传输层协议
- 基于现有互联网上部署新型协议会遭遇很大的困难。用户与服务器之间要经过许多防火墙、NAT（地址转换）、路由器和其他中间设备（middle-box），这些设备
有很多只认TCP和UDP
- 传输层协议改动一般意味着操作系统内核也要做出修改。更新和部署新款操作系统内核的过程十分缓慢，需要付出很大的努力
#### SCTP
SCTP是一个支持数据流的可靠的传输层协议，而且在WebRTC上已有基于UDP的对它的实现，但它存在以下问题：
- 没有解决数据流的队头阻塞问题
- 连接建立时需要决定数据流的数量
- 没有稳固的TLS/安全性支持
- 建立连接时候需要4次握手，而QUIC一次都不用（0-RTT）
- QUIC是类TCP的字节流，而SCTP是信息流（message-based）
- QUIC连接支持IP地址迁移，SCTP不行
#### 协议僵化
互联网上的关键中间设备，比如路由器等，经常跟不上最新的技术。网络的核心部分与边缘部分（客户端、服务器）相比，更新很慢。所以当这些设备决定了经过的流量
是否合格时，就有些问题了——在这些设备部署之后的一段时间里，协议有了新的特征。而在这些设备引入（了解）这些新特性之前，它们会认为这种特征的数据包是非
法的、恶意的，于是会将这种流量直接扔掉，或是拖延到用户不再想使用这些新特征的程度。这种问题就被称之为`协议僵化`

当中间设备检测到对于它们来说未知的新的TCP选项时，中间设备将拦截这些流量

***尽可能将通信加密是对抗僵化的唯一有效手段，加密可以防止中间设备看到协议传输的绝大部分内容。***

#### 安全性
QUIC始终保证安全性。QUIC协议没有明文的版本，所以想要建立一个QUIC连接，就必须通过TLS 1.3来安全地建立一个加密连接。如上文所说，加密可以避免协议僵化
等拦截和特殊处理。这也使QUIC具有了Web用户所期望的所有的HTTPS安全特性。QUIC只在加密协议协商时会发送几个明文传送的初始握手报文。

#### 减少延迟
与TCP的3次握手相比，QUIC提供了0-RTT和1-RTT的握手，这减少了协商和建立新连接时所需的时间。除此之外，QUIC提供了提早传输更多数据的“早期数据”
（early data）特性，并且它的使用比TCP快速打开（TCP Fast Open）更加简便。因为数据流概念的引入，客户端不用等待前一个连接结束，便可以与同一个主机
建立另一个逻辑连接。


### QUIC协议特点
- 基于UDP的传输层协议。有一些网络上的中间设备会拦截端口53（用于DNS）以外的UDP流量。还有一些网络会节流（throttle）UDP流量，使得QUIC的表现慢于基于TCP的协议。更多网络的表现未知。
- 可靠。在不可靠的UDP之上增加了一层可靠性的层。提供数据包重传、拥塞控制、调整传输节奏（pacing）以及其他一些TCP中存在的特性
- 数据流。QUIC在同一物理连接上可以有多个独立的逻辑数据流。这些数据流并行在同一个连接上传输，不影响其他流
- 有序交付。QUIC的单个数据流可以保证有序交付，但多个数据流之间可能乱序
- 快速握手。QUIC提供0-RTT和1-RTT的连接建立，这意味着QUIC在最佳情况下不需要任何的额外往返时间便可建立新连接。其中更快的0-RTT仅在两个主机之间建立过连接且缓存了该连接的“秘密”（secret）时可以使用。
- 使用TLS1.3传输层安全协议，天生自带加密机制。TLS 1.3有着很多优点，但使用它的最主要原因是其握手所花费的往返次数更低，从而能降低协议的延迟。
- QUIC之上的HTTP协议。
    + HTTP/2中使用HPACK压缩头部，HPACK算法依赖于数据流的有序交付
    + 由于HTTP/3的数据流之间可能乱序，因此需要改进HPACK。HTTP使用QPACK压缩头部

### QUIC工作原理
- 建立一个连接。QUIC连接是两个QUIC端点之间的单次会话（conversation）过程。QUIC建立连接时，加密算法的版本协商与传输层握手合并完成，以减小延迟。
在连接上实际传输数据时需要建立并使用一个或多个数据流。
- 协商安全的TLS连接
- 使用数据流
- 0-RTT。先前已连接过一个服务器的客户端可能缓存来自该连接的某些参数，并在之后与该服务器建立一个无需等待握手完成就可以立即传输信息的0-RTT连接，从而减少建立新连接所必需的时间。


### HTTP3
为了使HTTP可以通过QUIC传输，协议的某些方面要进行修改，修改的结果便是HTTP/3。这些必要修改是因QUIC与TCP在某些性质上的不同所致，修改包括：
- 在QUIC中，数据流由传输层本身提供，而在HTTP/2中，流由HTTP层完成。
- 由于数据流互相独立，HTTP/2中使用的头部压缩算法如果不做改动，会造成队头阻塞。
- QUIC流与HTTP/2略有不同。
- HTTP/3将使用HTTPS:// URL履行
- HTTP服务器响应头可以设置：Alt-Svc: h3=":50781"，这指示了同一名称的主机在UDP端口50781提供HTTP/3服务


### HTTP3与HTTP2的比较
HTTP/3面向QUIC设计，QUIC是一个自己处理数据流的传输层协议。

HTTP/2面向TCP设计，因此数据流在HTTP层处理。

#### 相似之处
这两个协议为客户端提供了几乎相同的功能集。
- 两者都提供数据流
- 两者都提供服务器推送
- 两者都有头部压缩，QPACK与HPACK的设计非常类似
- 两者都通过单一连接上的数据流提供复用
- 两者都提供数据流的优先度设置

#### 不同之处
两个协议的主要不同点在于细节，不同之处主要由HTTP/3使用的QUIC带来。
- 得益于QUIC的0-RTT握手，HTTP/3可以提供更好的早期数据支持，而TCP快速打开和TLS通常只能传输更少的数据，且经常存在问题。
- 得益于QUIC，HTTP/3的握手速度比TCP+TLS快得多。
- HTTP/3不存在明文的不安全版本。尽管在互联网上很少见，HTTP/2还是可以不配合HTTPS来实现和使用。
- 通过ALPN拓展，HTTP/2可以直接在TLS握手时进行协商。HTTP/3基于QUIC，所以需要凭借响应中的 Alt-Svc: 头部来向客户端宣告
